# This makes travis use the thin image which boots faster
language: generic

# sudo:required is needed for trusty images
sudo: required

services:
  - docker

before_install:
  # The user we create inside the docker container needs to have the
  # same UID/GID as the files on the travis bind volume we're going
  # to mount
  - sed -i -e "/useradd/i RUN groupadd -g $(id -g) mapbox" -e "s/useradd/useradd -u $(id -u) -g $(id -g)/" docker/Dockerfile

install:
  - docker build -t mapbox/route-annotator:1.0 docker/

notifications:
  email: true

before_script:
  - cd ${TRAVIS_BUILD_DIR}
  - echo ${TRAVIS_BUILD_DIR}
  - pwd
  - export CC=${CCOMPILER} CXX=${CXXCOMPILER}
  - ls -la

script:
  - docker run --env="CXX=g++-5" --env="CC=gcc-5" --volume=${TRAVIS_BUILD_DIR}:/home/mapbox/route-annotator --workdir=/home/mapbox/route-annotator mapbox/route-annotator:1.0 npm install
  # We do the download synchronously
  - docker run --env="CXX=g++-5" --env="CC=gcc-5" --volume=${TRAVIS_BUILD_DIR}:/home/mapbox/route-annotator --workdir=/home/mapbox/route-annotator --publish=5000:5000 --detach mapbox/route-annotator:1.0 npm test-setup
  # Now run the demo server and detach
  - docker run --env="CXX=g++-5" --env="CC=gcc-5" --volume=${TRAVIS_BUILD_DIR}:/home/mapbox/route-annotator --workdir=/home/mapbox/route-annotator --publish=5000:5000 --detach mapbox/route-annotator:1.0 npm test
  - sleep 2 # Wait for the daemon to start up
  - curl "http://localhost:5000/coordlist/7.422155,43.7368838;7.4230139,43.7369751"
  - docker logs $(docker ps -l -q)
  - docker stop $(docker ps -l -q)
